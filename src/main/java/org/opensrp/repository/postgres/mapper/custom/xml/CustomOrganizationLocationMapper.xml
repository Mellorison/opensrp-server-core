<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="org.opensrp.repository.postgres.mapper.custom.CustomOrganizationLocationMapper">

  <resultMap id="BaseResultMap" type="org.opensrp.domain.AssignedLocations">
    <result column="identifier" jdbcType="VARCHAR" property="planId" />
    <result column="geojson_id" jdbcType="VARCHAR" property="jurisdictionId" />
    <result column="from_date" jdbcType="TIMESTAMP" property="fromDate" />
    <result column="to_date" jdbcType="TIMESTAMP" property="toDate" />
  </resultMap>
  
   <sql id="Base_Column_List">
       p.identifier,l.geojson_id,ol.from_date,ol.to_date
    </sql>
  
	<select id="findAssignedlocationsAndPlans"
		resultMap="BaseResultMap">
		select
		<include
			refid="Base_Column_List" />
		from team.organization_location ol
		left join core.plan p on p.id=ol.plan_id
		left join core.location_metadata l on l.location_id=ol.location_id
		where ol.organization_id = #{organizationId,jdbcType=BIGINT} AND ol.from_date <![CDATA[ >= ]]>  #{fromDate,jdbcType=TIMESTAMP} 
		and ( ol.to_date is null  OR ol.to_date  <![CDATA[ <= ]]> #{toDate,jdbcType=TIMESTAMP} )	
	</select>
	
	
	<select id="selectByExampleAndDateTo"
		resultMap="org.opensrp.repository.postgres.mapper.OrganizationLocationMapper.BaseResultMap">
		select
		<include
			refid="org.opensrp.repository.postgres.mapper.OrganizationLocationMapper.Base_Column_List" />
		from team.organization_location ol
		<if test="oredCriteria != null">
			<include refid="org.opensrp.repository.postgres.mapper.OrganizationLocationMapper.Example_Where_Clause" />
		</if>
		<trim prefixOverrides="and">
		 ( ol.to_date is null  OR ol.to_date  <![CDATA[ <= ]]> #{currentDate,jdbcType=TIMESTAMP} )
		</trim>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>	
	</select>

</mapper>
